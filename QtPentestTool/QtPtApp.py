# Copyright (c) 2019 vonKrafft <contact@vonkrafft.fr>
# 
# This file is part of QtPentestTool.
# 
# This file may be used under the terms of the GNU General Public License
# version 3.0 as published by the Free Software Foundation and appearing in
# the file LICENSE included in the packaging of this file. Please review the
# following information to ensure the GNU General Public License version 3.0
# requirements will be met: http://www.gnu.org/copyleft/gpl.html.
# 
# This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE
# WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.

import notify2
import time
import os

from unicodedata import normalize

from PyQt5 import QtWidgets
from PyQt5 import QtCore
from PyQt5 import QtGui

from . import QtPtCore
from . import QtPtObjects
from . import QtPtWidgets

class QPentestToolApp(QtWidgets.QMainWindow):
    """Main window for QtPentestTool.

    Attributes:
        currentProj (QtPtObjects.QProject)
        currentVuln (QtPtObjects.QVulnerability)

        settings (QtCore.QSettings)

        centralLayout (QtWidgets.QGridLayout)
        centralWidget (QtWidgets.QWidget)

        menubar (QtPtWidgets.QAppMenuBar)
        navbarWidget (QtPtWidgets.QNavbarWidget)
        projWidget (QtPtWidgets.QProjectWidget)
        titleWidget (QtPtWidgets.QTitleWidget)
        vulnWidget (QtPtWidgets.QVulnerabilityWidget)

    Constants:
        APP_TITLE (str): The application name
        APP_ICON (str): Path of the application icon
        APP_AUTHOR (str): The author's nickname
        APP_EMAIL (str): The author's email
        APP_VERSION (str): The current version of the application
        APP_SCANS_DIR (str): Configuration folder where to store scans' templates
        APP_CONF_FILE (str): Configuration file where to store application's settings

    """

    """ The application name """
    APP_TITLE = 'QtPentestTool'

    """ Path of the application icon """
    APP_ICON = os.path.abspath(os.path.join(os.path.dirname(__file__), '..', 'Resources', 'QtPentestTool-icon-64.png'))

    """ The author's nickname """
    APP_AUTHOR = '@v0nKrafft'

    """ The author's email """
    APP_EMAIL = 'contact@vonkrafft.fr'

    """ The current version of the application """
    APP_VERSION = '1.0'

    """ Configuration folder where to store scans' templates """
    APP_SCANS_DIR = os.path.expanduser('~/.config/QtPentestTool/scans')

    """ Configuration file where to store application's settings """
    APP_CONF_FILE = os.path.expanduser('~/.config/QtPentestTool/config.json')

    """ The current project displayed in the GUI """
    currentProj = None

    """ The current vulnerability displayed in the GUI """
    currentVuln = None
    
    def __init__(self, *argv, **kwargs) -> None:
        """ Class constructor.

        Args:
            *args: Variable length argument list
            **kwargs: Arbitrary keyword arguments

        """
        super(QPentestToolApp, self).__init__(*argv, **kwargs)

        self.settings = QtCore.QSettings('QtPentestTool', 'QtPtApp')

        self.settings.setValue('global/workdir', self.settings.value('global/workdir', QtCore.QDir.homePath()))
        self.settings.setValue('global/archive', self.settings.value('global/archive', 'tar'))
        self.settings.setValue('global/delay', self.settings.value('global/delay', 5))

        self.statusBar()

        self.centralLayout = QtWidgets.QGridLayout()
        self.centralLayout.setRowStretch(2, 1)

        self.centralWidget = QtWidgets.QWidget(self)
        self.centralWidget.setLayout(self.centralLayout)
        self.setCentralWidget(self.centralWidget)

        self.titleWidget = QtPtWidgets.QTitleWidget(self)
        self.centralLayout.addWidget(self.titleWidget, 0, 0, 1, 2)

        self.projWidget = QtPtWidgets.QProjectWidget(self)
        self.centralLayout.addWidget(self.projWidget, 1, 0, 1, 1)

        self.projWidget.newClicked.connect(self.newProject)
        self.projWidget.editClicked.connect(self.editProject)
        self.projWidget.exportClicked.connect(self.exportProject)
        self.projWidget.screenshotClicked.connect(self.screenshotProject)
        self.projWidget.terminalClicked.connect(self.terminalProject)
        self.projWidget.targetBrowserClicked.connect(self.openExternalUrl)

        self.navbarWidget = QtPtWidgets.QNavbarWidget(self)
        self.centralLayout.addWidget(self.navbarWidget, 2, 0, 1, 1)

        self.navbarWidget.currentItemChanged.connect(self.switchVulnerability)
        self.navbarWidget.currentItemUnset.connect(self.unsetVulnerability)
        self.navbarWidget.addClicked.connect(self.addVulnerability)
        self.navbarWidget.saveClicked.connect(self.saveVulnerability)
        self.navbarWidget.removeClicked.connect(self.removeVulnerability)

        self.vulnWidget = QtPtWidgets.QVulnerabilityWidget(self)
        self.centralLayout.addWidget(self.vulnWidget, 1, 1, 2, 1)

        self.vulnWidget.takeScreenshotClicked.connect(self.screenshotVulnerability)

        self.menubar = QtPtWidgets.QAppMenuBar(self)
        self.setMenuBar(self.menubar)

        self.menubar.newProjAct.triggered.connect(self.newProject)
        self.menubar.openProjAct.triggered.connect(self.openProject)
        self.menubar.editProjAct.triggered.connect(self.editProject)
        self.menubar.screenProjAct.triggered.connect(self.screenshotProject)
        self.menubar.scanProjAct.triggered.connect(self.scanOpenProject)
        self.menubar.folderProjAct.triggered.connect(self.folderOpenProject)
        self.menubar.refreshProjAct.triggered.connect(self.updateProject)
        self.menubar.exportProjAct.triggered.connect(self.exportProject)

        self.menubar.newVulnAct.triggered.connect(self.addVulnerability)
        self.menubar.saveVulnAct.triggered.connect(self.saveVulnerability)
        self.menubar.deleteVulnAct.triggered.connect(self.removeVulnerability)
        self.menubar.renameVulnAct.triggered.connect(self.renameVulnerability)
        self.menubar.screenVulnAct.triggered.connect(self.screenshotVulnerability)
        self.menubar.folderVulnAct.triggered.connect(self.folderOpenVulnerability)
        self.menubar.fileVulnAct.triggered.connect(self.fileOpenVulnerability)
        
        self.menubar.updateRecentMenu(QtPtObjects.QProject.enum(self.settings.value('global/workdir')))
        self.menubar.recentMenuTriggered.connect(self.openRecentProject)

        self.menubar.preferencesAct.triggered.connect(self.preferences)

        self.menubar.updateScanMenu(self.APP_SCANS_DIR, enabled=isinstance(self.currentProj, QtPtObjects.QProject))
        self.menubar.scanMenuTriggered.connect(self.runScan)
        self.menubar.folderScanAct.triggered.connect(self.openScansFolder)
        self.menubar.refreshScanAct.triggered.connect(self.refreshScanMenu)
        self.menubar.templateScanAct.triggered.connect(self.createScanTemplate)

        self.menubar.aboutAct.triggered.connect(self.about)
        self.menubar.aboutQtAct.triggered.connect(self.aboutQt)

        self.updateProject()

        self.resize(kwargs.get('width', 990), kwargs.get('height', 640))
        self.setWindowTitle(self.APP_TITLE)
        self.setWindowIcon(QtGui.QIcon(self.APP_ICON))
        self.show()

    def resizeEvent(self, event: 'QtGui.QResizeEvent') -> None:
        """ Override the parent method. The resize event is called whenever 
        the window is resized in the windowing system, either directly through 
        the windowing system acknowledging a setGeometry() or resize() request, 
        or indirectly through the user resizing the window manually.

        Args:
            event (QtGui.QResizeEvent): The handled event

        """
        self.projWidget.setMaximumWidth(max(380, int(0.2 * self.frameGeometry().width())))
        self.navbarWidget.setMaximumWidth(max(380, int(0.2 * self.frameGeometry().width())))
        super(QPentestToolApp, self).resizeEvent(event)

    def notify(self, message: str, msecs: int = 5000) -> None:
        """ Send a notification using a D-Bus connection.

        Args:
            message (str): The notice message to display
            msecs (int, optional): Delay to hide the notification, in milliseconds (default 5000)

        """
        notify2.init(self.APP_TITLE)
        notice = notify2.Notification(self.APP_TITLE, message, self.APP_ICON)
        notice.set_timeout(int(msecs))
        notice.show()
        notify2.uninit()

    def closeEvent(self, event: 'QtGui.QCloseEvent') -> None:
        """ Override the parent method to save the opened project and vulnerability.

        Args:
            event (QtGui.QCloseEvent): The handled event

        """
        self.writePreviousVulnerability()

    def about(self) -> None:
        """ Show an "about" dialog with application information.

        """
        QtWidgets.QMessageBox.about(self, 'About', f'{self.APP_TITLE} v{self.APP_VERSION}\n{self.APP_AUTHOR}\n{self.APP_EMAIL}')

    def aboutQt(self) -> None:
        """ Show an "about Qt" dialog with Qt information.

        """
        QtWidgets.QMessageBox.aboutQt(self, 'About Qt')

    def preferences(self) -> None:
        """ Open the preferences dialog and and handle the modification or 
        not of the settings.

        """
        dialog = QtPtWidgets.QSettingsDialog(self)
        settings, ok = dialog.openPreferences(self.APP_TITLE)
        if ok and isinstance(settings, QtCore.QSettings):
            self.settings = settings
            self.updateProject()

    def openExternalUrl(self, url: str) -> None:
        """ Open the given URL using 'xdg-open'.

        Args:
            url (str): The URL, folder or file to open

        """
        process = QtCore.QProcess(self)
        process.start('xdg-open', [url])

    # **************************************************************************
    # SCAN
    # **************************************************************************

    def runScan(self, path: str) -> None:
        """ Run a scan using the given path to a scan's JSON file.

        Args:
            path (str): Filename of the JSON file

        """
        command, ok = QtPtWidgets.QScanDialog.configureScan(path, self.currentProj, self.APP_TITLE, self)

        if ok is True:
            dialog = QtPtWidgets.QTerminalDialog(self)
            dialog.run(command, self.APP_TITLE)

        self.refreshScanMenu()

    def openScansFolder(self) -> None:
        """ Open the scans' folder using 'xdg-open'.

        """
        process = QtCore.QProcess(self)
        process.start('xdg-open', [self.APP_SCANS_DIR])

    def createScanTemplate(self) -> None:
        """ Open a dialog to create a new scan as a JSON file.

        """
        scanPath, ok = QtPtWidgets.QScanTemplateDialog.openTemplateCreator(self.APP_SCANS_DIR, self.APP_TITLE, self)

        if ok is True:
            self.refreshScanMenu()

    def refreshScanMenu(self) -> None:
        """ Refresh the scan menu.

        """
        if isinstance(self.currentProj, QtPtObjects.QProject):
            self.menubar.updateScanMenu(self.APP_SCANS_DIR, self.currentProj.scansPath(), enabled=True)
        else:
            self.menubar.updateScanMenu(self.APP_SCANS_DIR, enabled=False)

    # **************************************************************************
    # PROJECT
    # **************************************************************************

    def setProject(self, proj: 'QtPtObjects.QProject') -> None:
        """ Display the given project in the main window.

        Args:
            proj (QtPtObjects.QProject): The project to display

        """
        self.currentProj = proj
        self.updateProject()

    def unsetProject(self) -> None:
        """ Close the current displayed project.

        """
        self.currentProj = None
        self.updateProject()

    def updateProject(self) -> None:
        """ Update the project's GUI.

        """
        self.titleWidget.setVisible(isinstance(self.currentProj, QtPtObjects.QProject))
        self.projWidget.setVisible(isinstance(self.currentProj, QtPtObjects.QProject))
        self.navbarWidget.setVisible(isinstance(self.currentProj, QtPtObjects.QProject))
        self.vulnWidget.setVisible(isinstance(self.currentVuln, QtPtObjects.QVulnerability))

        self.menubar.setEnableProjectActions(isinstance(self.currentProj, QtPtObjects.QProject))
        self.menubar.setEnableVulnerabilityActions(isinstance(self.currentVuln, QtPtObjects.QVulnerability))
        self.refreshScanMenu()

        if isinstance(self.currentVuln, QtPtObjects.QVulnerability):
            self.saveVulnerability()
        keptVuln = self.currentVuln

        if isinstance(self.currentProj, QtPtObjects.QProject):
            self.currentProj.loadVulnerabilities()
            self.titleWidget.setProject(self.currentProj)
            self.projWidget.setProject(self.currentProj)
            self.navbarWidget.setItems(self.currentProj.vulnerabilities())

        if isinstance(keptVuln, QtPtObjects.QVulnerability):
            self.navbarWidget.setCurrentItem(keptVuln)

        self.setWindowTitle('{name} ({client}) - {app}'.format(
            name=self.currentProj.get('name', 'Untitled project'), 
            client=self.currentProj.get('client', 'MISC'),
            app=self.APP_TITLE
        ) if isinstance(self.currentProj, QtPtObjects.QProject) else self.APP_TITLE)

    def exportProject(self) -> None:
        """ Export the current project as an archive.

        """
        self.statusBar().showMessage('Exporting project ...', msecs=5000)
        self.notify('Exporting project ...')
        
        archive = self.currentProj.export(format=self.settings.value('global/archive'))

        if archive is None:
            self.statusBar().showMessage('Unable to export the project', msecs=5000)
            return

        self.statusBar().showMessage(f'The project has been exported to {archive}', msecs=5000)
        self.notify(f'The project has been exported to {archive}')

    def openProject(self) -> None:
        """ Show a dialog to choose a project to open.

        """
        project, ok = QtPtWidgets.QProjectDialog.getOpenProject(self.settings.value('global/workdir'), self.APP_TITLE, self)

        if ok and isinstance(project, QtPtObjects.QProject):
            self.setProject(project)
            self.statusBar().showMessage(f'Project loaded from {self.currentProj.databasePath()}', msecs=5000)

    def openRecentProject(self, folder: str) -> None:
        """ Open a recent project using the given folder to lookup the project's database.

        Args:
            folder (str): The directory in which to search the project's database

        """
        project, ok = QtPtWidgets.QProjectDialog.getExistingProject(folder, self.APP_TITLE, self)

        if ok and isinstance(project, QtPtObjects.QProject):
            self.setProject(project)
            self.statusBar().showMessage(f'Project loaded from {self.currentProj.databasePath()}', msecs=5000)

    def newProject(self) -> None:
        """ Show a dialog to create a new project.

        """
        project, ok = QtPtWidgets.QProjectDialog.getNewProject(self.settings.value('global/workdir'), self.APP_TITLE, self)

        if ok and isinstance(project, QtPtObjects.QProject):
            self.setProject(project)
            self.menubar.updateRecentMenu(QtPtObjects.QProject.enum(self.settings.value('global/workdir')))
            self.statusBar().showMessage(f'Project created in {self.currentProj.databasePath()}', msecs=5000)

    def editProject(self) -> None:
        """ Show a dialog to edit the current project.

        """
        project, ok = QtPtWidgets.QProjectDialog.getEditProject(self.currentProj, self.APP_TITLE, self)

        if ok and isinstance(project, QtPtObjects.QProject):
            self.setProject(project)
            self.statusBar().showMessage(f'Project saved in {self.currentProj.databasePath()}', msecs=5000)

    def screenshotProject(self) -> None:
        """ Take a screenshot and save it in the project's directory.

        """
        if not os.path.isfile('/usr/bin/scrot'):
            self.statusBar().showMessage('Scrot is not installed!', msecs=5000)
            return

        self.statusBar().showMessage(f'A screenshot will be taken in {self.settings.value("global/delay")} seconds.', msecs=5000)

        time.sleep(int(self.settings.value('global/delay')))
        picture = self.currentProj.takeScreenshot()

        if picture is None:
            self.statusBar().showMessage('Unable to take a screenshot', msecs=5000)
            return notify2.uninit()

        self.statusBar().showMessage(f'Screenshot saved in {picture}', msecs=5000)
        self.notify(f'Screenshot saved in {picture}')

    def terminalProject(self) -> None:
        """ Export the current project as an archive.

        """
        process = QtCore.QProcess(self)
        process.start('x-terminal-emulator', ['--workdir', self.currentProj.absolutePath(), '-e', f'script "{self.currentProj.newShellLogFilename()}"'])

    def folderOpenProject(self) -> None:
        """ Open the project containing folder using 'xdg-open'.

        """
        process = QtCore.QProcess(self)
        process.start('xdg-open', [self.currentProj.absolutePath()])

    def scanOpenProject(self) -> None:
        """ Open the project scans folder using 'xdg-open'.

        """
        process = QtCore.QProcess(self)
        process.start('xdg-open', [self.currentProj.scansPath()])

    # **************************************************************************
    # VULNERABILITY
    # **************************************************************************

    def setVulnerability(self, vuln: 'QtPtObjects.QVulnerability') -> None:
        """ Display the given vulnerability in the main window.

        Args:
            proj (QtPtObjects.QVulnerability): The vulnerability to display

        """
        self.currentVuln = vuln
        self.updateVulnerability()

    def unsetVulnerability(self) -> None:
        """ Close the current displayed vulnerability.

        """  
        self.currentVuln = None
        self.updateVulnerability()

    def updateVulnerability(self) -> None:
        """ Update the vulnerability's GUI.

        """
        self.titleWidget.setVisible(isinstance(self.currentProj, QtPtObjects.QProject))
        self.projWidget.setVisible(isinstance(self.currentProj, QtPtObjects.QProject))
        self.navbarWidget.setVisible(isinstance(self.currentProj, QtPtObjects.QProject))
        self.vulnWidget.setVisible(isinstance(self.currentVuln, QtPtObjects.QVulnerability))

        self.menubar.setEnableProjectActions(isinstance(self.currentProj, QtPtObjects.QProject))
        self.menubar.setEnableVulnerabilityActions(isinstance(self.currentVuln, QtPtObjects.QVulnerability))
        self.refreshScanMenu()

        if isinstance(self.currentVuln, QtPtObjects.QVulnerability):
            self.vulnWidget.setVulnerability(self.currentVuln)

    def addVulnerability(self, placeholder: str = '') -> None:
        """ Open a dialog to add a new vulnerability.

        Args:
            placeholder (str, optional): A default value to set as vulnerability's name (default '')

        """
        self.writePreviousVulnerability()

        dialogBox = QtWidgets.QInputDialog(self)
        dialogBox.setInputMode(QtWidgets.QInputDialog.TextInput)
        dialogBox.setWindowTitle(f'New vulnerability - {self.APP_TITLE}')
        dialogBox.setLabelText('Provide the vulnerability name:')
        dialogBox.setTextValue(placeholder if isinstance(placeholder, str) else '')
        dialogBox.resize(400, 10)

        if not dialogBox.exec_():
            return

        folder = normalize('NFD', dialogBox.textValue()).encode('ascii', 'ignore').decode('utf-8')
        folder = QtPtObjects.QVulnerability.sanitizeVulnerabilityFolder(folder)

        if len(folder) == 0:
            msg = 'The vulnerability\'s name cannot be empty and has to contain at least one word character (A-Za-z0-9 -).'
            answer = QtWidgets.QMessageBox.critical(self, 'Error', msg, QtWidgets.QMessageBox.Cancel | QtWidgets.QMessageBox.Retry)
            if answer == QtWidgets.QMessageBox.Retry:
                self.addVulnerability(dialogBox.textValue())
            return

        newVuln = QtPtObjects.QVulnerability(os.path.join(self.currentProj.vulnsPath(), folder), version=self.currentProj.get('cvss_version'))
        newVuln.set('Name', dialogBox.textValue())

        if not newVuln.create():
            msg = 'The vulnerability already exists, please choose an other name.'
            answer = QtWidgets.QMessageBox.warning(self, 'Warning', msg, QtWidgets.QMessageBox.Cancel | QtWidgets.QMessageBox.Retry)
            if answer == QtWidgets.QMessageBox.Retry:
                self.addVulnerability()
            return

        self.currentVuln = newVuln
        self.currentProj.loadVulnerabilities()
        self.titleWidget.setScore(self.currentProj.vulnerabilities())
        self.navbarWidget.setItems(self.currentProj.vulnerabilities(), self.currentVuln)

        self.statusBar().showMessage(f'Vulnerability created in {self.currentVuln.databasePath()}', msecs=5000)

    def saveVulnerability(self, currentVuln: 'QtPtObjects.QVulnerability' = None) -> None:
        """ Save the given vulnerability, or the current displayed vulnerability if not provided.

        Args:
            currentVuln (QtPtObjects.QVulnerability): The vulnerability to save

        """
        currentVuln = currentVuln or self.currentVuln

        currentVuln.set('Name', self.vulnWidget.nameInput.text())
        currentVuln.set('URL', self.vulnWidget.urlInput.text())
        currentVuln.set('Account', self.vulnWidget.accountInput.text())
        currentVuln.set('OWASP', self.vulnWidget.owaspInput.currentText())
        currentVuln._description = self.vulnWidget.contentInput.description()
        currentVuln._impact = self.vulnWidget.contentInput.impact()
        currentVuln._remediation = self.vulnWidget.contentInput.remediation()
        currentVuln._cvss = self.vulnWidget.cvssWidget.cvss()
        currentVuln.write()

        self.setVulnerability(currentVuln)
        self.currentProj.loadVulnerabilities()
        self.titleWidget.setScore(self.currentProj.vulnerabilities())
        self.navbarWidget.setItems(self.currentProj.vulnerabilities(), self.currentVuln)

        self.statusBar().showMessage(f'Vulnerability saved in {currentVuln.databasePath()}', msecs=5000)

    def removeVulnerability(self, currentVuln: 'QtPtObjects.QVulnerability' = None) -> None:
        """ Remove the given vulnerability, or the current displayed vulnerability if not provided.

        Args:
            currentVuln (QtPtObjects.QVulnerability): The vulnerability to remove

        """
        currentVuln = currentVuln or self.currentVuln

        msg = 'Any deletion is final. Are you sure you want to remove the vulnerability?'
        answer = QtWidgets.QMessageBox.question(self, 'Confirm ?', msg, QtWidgets.QMessageBox.Abort | QtWidgets.QMessageBox.Yes)
        if answer != QtWidgets.QMessageBox.Yes:
            return

        if not currentVuln.delete():
            msg = 'An error occurred while removing the vulnerability. Please try again later.'
            answer = QtWidgets.QMessageBox.critical(self, 'Error', msg, QtWidgets.QMessageBox.Ok)
            return

        self.currentVuln = None
        self.currentProj.loadVulnerabilities()
        self.titleWidget.setScore(self.currentProj.vulnerabilities())
        self.navbarWidget.setItems(self.currentProj.vulnerabilities())

        self.statusBar().showMessage('Vulnerability deleted', msecs=5000)

    def switchVulnerability(self, currentVuln: 'QtPtObjects.QVulnerability' = None) -> None:
        """ Switch to the given vulnerability, or to the current displayed vulnerability if not provided.

        Args:
            currentVuln (QtPtObjects.QVulnerability): The vulnerability on which to switch

        """
        currentVuln = currentVuln or self.currentVuln

        self.writePreviousVulnerability()

        dirname = self.currentProj.sanitizeVulnerabilityPath(currentVuln.absolutePath())
        if QtPtObjects.QVulnerability.isVulnerability(dirname):
            self.setVulnerability(QtPtObjects.QVulnerability(dirname).read())

    def renameVulnerability(self, currentVuln: 'QtPtObjects.QVulnerability' = None) -> None:
        """ Rename the given vulnerability, or the current displayed vulnerability if not provided.
        Use the vulnerability's name to rename the containing folder.

        Args:
            currentVuln (QtPtObjects.QVulnerability): The vulnerability to rename

        """
        currentVuln = currentVuln or self.currentVuln

        self.currentVuln.write()
        self.statusBar().showMessage(f'Vulnerability saved in {self.currentVuln.databasePath()}', msecs=5000)

        folder = normalize('NFD', self.currentVuln.get('name')).encode('ascii', 'ignore').decode('utf-8')
        folder = QtPtObjects.QVulnerability.sanitizeVulnerabilityFolder(folder)

        if len(folder) == 0:
            msg = 'The vulnerability\'s name cannot be empty and has to contain at least one word character (A-Za-z0-9 -).'
            answer = QtWidgets.QMessageBox.critical(self, 'Error', msg, QtWidgets.QMessageBox.Ok)
            return

        if not self.currentVuln.move(folder):
            msg = 'The vulnerability already exists, please choose an other name.'
            answer = QtWidgets.QMessageBox.warning(self, 'Warning', msg, QtWidgets.QMessageBox.Ok)
            return

        self.setVulnerability(self.currentVuln)
        self.currentProj.loadVulnerabilities()
        self.titleWidget.setScore(self.currentProj.vulnerabilities())
        self.navbarWidget.setItems(self.currentProj.vulnerabilities(), self.currentVuln)

        self.statusBar().showMessage(f'Vulnerability moved in {self.currentVuln.databasePath()}', msecs=5000)

    def writePreviousVulnerability(self) -> 'setProject.QVulnerability':
        """ Save the current opened vulnerability and return it. Return None if 
        there is no current vulnerability or if the current is unchanged.

        Returns:
            QtPtObjects.QVulnerability: The saved vulnerability, or None

        """
        previousVuln = self.vulnWidget.saveCurrentVulnerability()
        if previousVuln is not None:
            self.currentProj.loadVulnerabilities()
            self.titleWidget.setScore(self.currentProj.vulnerabilities())
            self.navbarWidget.updateItem(previousVuln)
            self.statusBar().showMessage(f'Vulnerability saved in {previousVuln.databasePath()}', msecs=5000)

        return previousVuln

    def screenshotVulnerability(self) -> None:
        """ Take a screenshot and save it in the vulnerability's directory.

        """
        if not os.path.isfile('/usr/bin/scrot'):
            self.statusBar().showMessage('Scrot is not installed!', msecs=5000)
            return

        self.statusBar().showMessage(f'A screenshot will be taken in {self.settings.value("global/delay")} seconds.', msecs=5000)

        time.sleep(int(self.settings.value('global/delay')))
        picture = self.currentVuln.takeScreenshot()

        if picture is None:
            self.statusBar().showMessage('Unable to take a screenshot', msecs=5000)
            return notify2.uninit()

        self.statusBar().showMessage(f'Screenshot saved in {picture}', msecs=5000)
        self.notify(f'Screenshot saved in {picture}')

        time.sleep(0.5)
        self.saveVulnerability()
        self.updateVulnerability()

    def folderOpenVulnerability(self) -> None:
        """ Open the vulnerability containing folder using 'xdg-open'.

        """
        process = QtCore.QProcess(self)
        process.start('xdg-open', [self.currentVuln.absolutePath()])

    def fileOpenVulnerability(self) -> None:
        """ Open the vulnerability associated file using 'xdg-open'.

        """
        process = QtCore.QProcess(self)
        process.start('xdg-open', [self.currentVuln.databasePath()])

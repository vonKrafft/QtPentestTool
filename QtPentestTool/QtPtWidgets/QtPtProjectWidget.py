# Copyright (c) 2019 vonKrafft <contact@vonkrafft.fr>
# 
# This file is part of QtPentestTool.
# 
# This file may be used under the terms of the GNU General Public License
# version 3.0 as published by the Free Software Foundation and appearing in
# the file LICENSE included in the packaging of this file. Please review the
# following information to ensure the GNU General Public License version 3.0
# requirements will be met: http://www.gnu.org/copyleft/gpl.html.
# 
# This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE
# WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.

from PyQt5 import QtCore
from PyQt5 import QtGui
from PyQt5 import QtWidgets

from .. import QtPtObjects

import re # PyQt5.QtCore.QRegExp has no replace method, thus "re" is needed


class QProjectWidget(QtWidgets.QWidget):
    """Project widget for QtPentestTool.

    Attributes:
        layout (QtWidgets.QVBoxLayout): Current widget's layout

        buttonsLayout (QtWidgets.QGridLayout)
        buttonsWidget (QtWidgets.QWidget)

        newButton (QtWidgets.QPushButton)
        editButton (QtWidgets.QPushButton)
        exportButton (QtWidgets.QPushButton)
        screenshotButton (QtWidgets.QPushButton)
        termButton (QtWidgets.QPushButton)

        targetsList (QtWidgets.QListWidget)
        accountsList (QtWidgets.QListWidget)

    Signals:
        newClicked (QtCore.pyqtSignal)
        editClicked (QtCore.pyqtSignal)
        exportClicked (QtCore.pyqtSignal)
        screenshotClicked (QtCore.pyqtSignal)
        terminalClicked (QtCore.pyqtSignal)
        targetBrowserClicked (QtCore.pyqtSignal)

    """

    """ SIGNAL emitted when 'new' button is clicked """
    newClicked = QtCore.pyqtSignal()

    """ SIGNAL emitted when 'edit' button is clicked """
    editClicked = QtCore.pyqtSignal()

    """ SIGNAL emitted when 'export' button is clicked """
    exportClicked = QtCore.pyqtSignal()

    """ SIGNAL emitted when 'screenshot' button is clicked """
    screenshotClicked = QtCore.pyqtSignal()

    """ SIGNAL emitted when 'terminal' button is clicked """
    terminalClicked = QtCore.pyqtSignal()

    """ SIGNAL emitted when 'target' button is clicked """
    targetBrowserClicked = QtCore.pyqtSignal(str)

    def __init__(self, *args, **kwargs) -> None:
        """ Class constructor.

        Args:
            *args: Variable length argument list
            **kwargs: Arbitrary keyword arguments

        """
        super(QProjectWidget, self).__init__(*args, **kwargs)

        self.layout = QtWidgets.QVBoxLayout()
        self.layout.setContentsMargins(0, 0, 0, 0)
        self.setLayout(self.layout)

        # Buttons

        self.buttonsLayout = QtWidgets.QGridLayout()
        self.buttonsLayout.setContentsMargins(0, 0, 0, 0)

        self.buttonsWidget = QtWidgets.QWidget(self)
        self.buttonsWidget.setLayout(self.buttonsLayout)

        self.newButton = QtWidgets.QPushButton(QtGui.QIcon.fromTheme('folder-new'), 'New', self)
        self.newButton.clicked[bool].connect(self.__newProject)
        self.newButton.setFocusPolicy(QtCore.Qt.NoFocus)
        self.newButton.setStatusTip('Create a new project')
        self.buttonsLayout.addWidget(self.newButton, 0, 1)

        self.editButton = QtWidgets.QPushButton(QtGui.QIcon.fromTheme('document-properties'), 'Edit', self)
        self.editButton.clicked[bool].connect(self.__editProject)
        self.editButton.setFocusPolicy(QtCore.Qt.NoFocus)
        self.editButton.setStatusTip('Edit the current project')
        self.buttonsLayout.addWidget(self.editButton, 0, 2)

        self.exportButton = QtWidgets.QPushButton(QtGui.QIcon.fromTheme('package-x-generic'), 'Export', self)
        self.exportButton.clicked[bool].connect(self.__exportProject)
        self.exportButton.setFocusPolicy(QtCore.Qt.NoFocus)
        self.exportButton.setStatusTip('Compress the current project')
        self.buttonsLayout.addWidget(self.exportButton, 0, 3)

        self.screenshotButton = QtWidgets.QPushButton(QtGui.QIcon.fromTheme('insert-image'), 'Project\'s screenshot', self)
        self.screenshotButton.clicked[bool].connect(self.__takeScreenshot)
        self.screenshotButton.setFocusPolicy(QtCore.Qt.NoFocus)
        self.screenshotButton.setStatusTip('Capture the current screen after 5 seconds and save it into current project')
        self.buttonsLayout.addWidget(self.screenshotButton, 0, 4)

        self.termButton = QtWidgets.QPushButton(QtGui.QIcon.fromTheme('utilities-terminal'), '', self)
        self.termButton.clicked[bool].connect(self.__openTerminal)
        self.termButton.setFocusPolicy(QtCore.Qt.NoFocus)
        self.termButton.setStatusTip('Open a new terminal')
        self.buttonsLayout.addWidget(self.termButton, 0, 5)

        # Targets

        self.targetsList = QtWidgets.QListWidget(self)
        self.targetsList.setFocusPolicy(QtCore.Qt.NoFocus)
        self.targetsList.setSelectionMode(QtWidgets.QAbstractItemView.NoSelection)
        self.targetsList.setMaximumHeight(95)

        self.targetsList.setContextMenuPolicy(QtCore.Qt.CustomContextMenu)
        self.targetsList.customContextMenuRequested.connect(self.__contextTargetMenu)

        # Accounts

        self.accountsList = QtWidgets.QListWidget(self)
        self.accountsList.setFocusPolicy(QtCore.Qt.NoFocus)
        self.accountsList.setSelectionMode(QtWidgets.QAbstractItemView.NoSelection)
        self.accountsList.setMaximumHeight(95)

        self.accountsList.setContextMenuPolicy(QtCore.Qt.CustomContextMenu)
        self.accountsList.customContextMenuRequested.connect(self.__contextAccountMenu)

        # QProjectWidget

        self.layout.addWidget(self.buttonsWidget)
        self.layout.addWidget(self.targetsList)
        self.layout.addWidget(self.accountsList)

    def setVisible(self, visible: bool = True) -> None:
        """ Display or hide buttons and list in the widget. The 'new' and 
        'edit' buttons cannot be visible at the same time.

        Args:
            visible (bool, optional): Either or not buttons are visible (default True)

        """
        self.buttonsWidget.setVisible(True)
        self.newButton.setVisible(not visible)
        self.editButton.setVisible(visible)
        self.exportButton.setEnabled(visible)
        self.screenshotButton.setEnabled(visible)
        self.termButton.setEnabled(visible)
        self.targetsList.setVisible(visible)
        self.accountsList.setVisible(visible)
        super(QProjectWidget, self).setVisible(True)

    def setProject(self, project: 'QtPtObjects.QProject') -> None:
        """ Fill the lists of targets and accounts with those of the given project.

        Args:
            project (QtPtObjects.QProject): The project for which to display accounts and targets

        """
        self.targetsList.clear()
        for row, target in enumerate(project.targets):
            targetItemWidget = QtWidgets.QLabel(re.sub(r'(https?://[^\s]+)', r'<a href="\1">\1</a>', str(target)))
            targetItemWidget.setStyleSheet('QLabel { padding: 0 .1em }')
            targetsListItem = QtWidgets.QListWidgetItem(self.targetsList)
            targetsListItem.setSizeHint(targetItemWidget.sizeHint())
            self.targetsList.addItem(targetsListItem)
            self.targetsList.setItemWidget(targetsListItem, targetItemWidget)
        self.targetsList.setVisible(len(project.targets) > 0)
        
        self.accountsList.clear()
        for row, account in enumerate(project.accounts):
            accountItemWidget = QtWidgets.QLabel(re.sub(r'^([^:]+):([^\s]+)', r'<b>\1</b>:<small>\2</small>', str(account)))
            accountItemWidget.setStyleSheet('QLabel { padding: 0 .1em }')
            accountsListItem = QtWidgets.QListWidgetItem(self.accountsList)
            accountsListItem.setSizeHint(accountItemWidget.sizeHint())
            self.accountsList.addItem(accountsListItem)
            self.accountsList.setItemWidget(accountsListItem, accountItemWidget)
        self.accountsList.setVisible(len(project.accounts) > 0)

    def __newProject(self) -> None:
        """ Emit 'newClicked' SIGNAL.

        """
        self.newClicked.emit()

    def __editProject(self) -> None:
        """ Emit 'editClicked' SIGNAL.

        """
        self.editClicked.emit()

    def __exportProject(self) -> None:
        """ Emit 'exportClicked' SIGNAL.

        """
        self.exportClicked.emit()

    def __takeScreenshot(self) -> None:
        """ Emit 'screenshotClicked' SIGNAL.

        """
        self.screenshotClicked.emit()

    def __openTerminal(self) -> None:
        """ Emit 'terminalClicked' SIGNAL.

        """
        self.terminalClicked.emit()

    def __contextTargetMenu(self, pos: 'QtCore.QPoint') -> None:
        """ Custom context menu created for the target's list

        Args:
            pos (QtCore.QPoint): The cursor position when the context menu is triggered

        """
        currentItem = self.sender().currentItem()
        targetText = self.targetsList.itemWidget(currentItem).text() if currentItem is not None else ''
        currentTarget = QtPtObjects.QTarget(fromString=QtGui.QTextDocumentFragment.fromHtml(targetText).toPlainText())
        self.sender().setCurrentItem(None)

        openBrowserAct = QtWidgets.QAction(QtGui.QIcon.fromTheme('applications-internet'), 'Open in browser')
        openBrowserAct.setEnabled(currentTarget.isLink())
        copyHostnameAct = QtWidgets.QAction(QtGui.QIcon.fromTheme('edit-copy'), 'Copy hostname/URL')
        copyHostnameAct.setEnabled(currentTarget.get('hostname') is not None)
        copyIpAddressAct = QtWidgets.QAction(QtGui.QIcon.fromTheme('edit-copy'), 'Copy IP address')
        copyIpAddressAct.setEnabled(currentTarget.get('ip') is not None)
        copyAllTargetAct = QtWidgets.QAction(QtGui.QIcon.fromTheme('edit-copy'), 'Copy full text')
        copyAllTargetAct.setEnabled(currentItem is not None)

        cmenu = QtWidgets.QMenu(self.sender())

        cmenu.addAction(openBrowserAct)
        cmenu.addSeparator()
        cmenu.addAction(copyHostnameAct)
        cmenu.addAction(copyIpAddressAct)
        cmenu.addSeparator()
        cmenu.addAction(copyAllTargetAct)

        action = cmenu.exec_(self.sender().mapToGlobal(pos))

        if action == openBrowserAct:
            self.targetBrowserClicked.emit(currentTarget.get('hostname', ''))
        elif action == copyHostnameAct:
            self.fillClipboard(currentTarget.get('hostname', ''), 'Hostname copied to clipboard')
        elif action == copyIpAddressAct:
            self.fillClipboard(currentTarget.get('ip', ''), 'IP address copied to clipboard')
        elif action == copyAllTargetAct:
            self.fillClipboard(currentItem.text() if currentItem is not None else '', 'Target copied to clipboard')

    def __contextAccountMenu(self, pos: 'QtCore.QPoint') -> None:
        """ Custom context menu created for the account's list

        Args:
            pos (QtCore.QPoint): The cursor position when the context menu is triggered

        """
        currentItem = self.sender().currentItem()
        accountText = self.accountsList.itemWidget(currentItem).text() if currentItem is not None else ''
        currentAccount = QtPtObjects.QAccount(fromString=QtGui.QTextDocumentFragment.fromHtml(accountText).toPlainText())
        self.sender().setCurrentItem(None)

        copyUsernameAct = QtWidgets.QAction(QtGui.QIcon.fromTheme('edit-copy'), 'Copy username')
        copyUsernameAct.setEnabled(currentAccount.get('username') is not None)
        copyPasswordAct = QtWidgets.QAction(QtGui.QIcon.fromTheme('edit-copy'), 'Copy password')
        copyPasswordAct.setEnabled(currentAccount.get('password') is not None)
        copyAllAccountAct = QtWidgets.QAction(QtGui.QIcon.fromTheme('edit-copy'), 'Copy full text')
        copyAllAccountAct.setEnabled(currentItem is not None)

        cmenu = QtWidgets.QMenu(self.sender())

        cmenu.addAction(copyUsernameAct)
        cmenu.addAction(copyPasswordAct)
        cmenu.addSeparator()
        cmenu.addAction(copyAllAccountAct)

        action = cmenu.exec_(self.sender().mapToGlobal(pos))

        if action == copyUsernameAct:
            self.fillClipboard(currentAccount.get('username', ''), 'Username copied to clipboard')
        elif action == copyPasswordAct:
            self.fillClipboard(currentAccount.get('password', ''), 'Password copied to clipboard')
        elif action == copyAllAccountAct:
            self.fillClipboard(currentItem.text() if currentItem is not None else '', 'Account copied to clipboard')

    def fillClipboard(self, text: str, statusMessage: str = 'Copied to clipboard') -> None:
        """ Copy the given text in the clipboard.

        Args:
            text (str): The text to copy
            statusMessage (str, optional): A message to display in the status bar of a QMainWindow (default 'Copied to clipboard')

        """
        QtWidgets.QApplication.clipboard().setText(text)
        if isinstance(self.window(), QtWidgets.QMainWindow):
            self.window().statusBar().showMessage(statusMessage, msecs=5000)
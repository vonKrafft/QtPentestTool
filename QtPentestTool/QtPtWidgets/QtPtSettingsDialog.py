# Copyright (c) 2019 vonKrafft <contact@vonkrafft.fr>
# 
# This file is part of QtPentestTool.
# 
# This file may be used under the terms of the GNU General Public License
# version 3.0 as published by the Free Software Foundation and appearing in
# the file LICENSE included in the packaging of this file. Please review the
# following information to ensure the GNU General Public License version 3.0
# requirements will be met: http://www.gnu.org/copyleft/gpl.html.
# 
# This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE
# WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.

from PyQt5 import QtCore
from PyQt5 import QtWidgets

from .. import QtPtWidgets

import shutil


class QSettingsDialog(QtWidgets.QDialog):
    """Settings dialog for QtPentestTool.

    Attributes:
        _settings (QtCore.QSettings): Settings object linked to the dialog

        layout (QtWidgets.QVBoxLayout): Current dialog's layout

        globalGroupBox (QtWidgets.QGroupBox)
        globalFormLayout (QtWidgets.QFormLayout)
        globalWorkdirInput (QtPtWidgets.QDirectoryPathBox)
        globalArchiveInput (QtWidgets.QComboBox)
        globalDelayInput (QtWidgets.QSpinBox)
        
        buttonBox (QtWidgets.QDialogButtonBox)

    """

    """ Settings object linked to the dialog """
    _settings = QtCore.QSettings('QtPentestTool', 'QtPtApp')

    def __init__(self, *args, **kwargs) -> None:
        """ Class constructor.

        Args:
            *args: Variable length argument list
            **kwargs: Arbitrary keyword arguments

        """
        super(QSettingsDialog, self).__init__(*args, **kwargs)
        self.setWindowModality(QtCore.Qt.ApplicationModal)
         
        self.layout = QtWidgets.QVBoxLayout()
        self.setLayout(self.layout)

        # Global

        self.globalGroupBox = QtWidgets.QGroupBox('Project\'s Preferences')
        self.globalFormLayout = QtWidgets.QFormLayout()
        self.globalFormLayout.setLabelAlignment(QtCore.Qt.AlignLeft)
        self.globalGroupBox.setMinimumWidth(500)
        self.globalGroupBox.setLayout(self.globalFormLayout)

        self.globalWorkdirInput = QtPtWidgets.QDirectoryPathBox()
        self.globalFormLayout.addRow(QtWidgets.QLabel('Working directory'), self.globalWorkdirInput)

        self.globalArchiveInput = QtWidgets.QComboBox()
        self.globalArchiveInput.setSizePolicy(QtWidgets.QSizePolicy.Expanding, QtWidgets.QSizePolicy.Expanding)
        self.globalArchiveInput.addItems([f[0] for f in shutil.get_archive_formats()])
        self.globalFormLayout.addRow(QtWidgets.QLabel('Archive format'), self.globalArchiveInput)

        self.globalDelayInput = QtWidgets.QSpinBox(minimum=0, maximum=60, suffix=' seconds')
        self.globalDelayInput.setSizePolicy(QtWidgets.QSizePolicy.Expanding, QtWidgets.QSizePolicy.Expanding)
        self.globalFormLayout.addRow(QtWidgets.QLabel('Screenshot delay'), self.globalDelayInput)

        # Buttons

        self.buttonBox = QtWidgets.QDialogButtonBox(QtWidgets.QDialogButtonBox.Ok | QtWidgets.QDialogButtonBox.Cancel)
        self.buttonBox.accepted.connect(self.accept)
        self.buttonBox.rejected.connect(self.reject)

        # QSettingsDialog

        self.layout.addWidget(self.globalGroupBox)
        self.layout.addWidget(self.buttonBox)

    def show(self) -> ('QtCore.QSettings', bool):
        """ Overwrite the parent method.

        Returns:
            (QtCore.QSettings, bool): The current settings and either or not the Accept button has been clicked

        """
        return self.exec_()

    def exec_(self) -> ('QtCore.QSettings', bool):
        """ Overwrite the parent method.

        Returns:
            (QtCore.QSettings, bool): The current settings and either or not the Accept button has been clicked

        """
        ret = super(QSettingsDialog, self).exec_()
        return self._settings, bool(ret)

    def setWindowTitle(self, dialogTitle: str, appTitle: str = None) -> None:
        """ Set the window title for the current dialog: <dialogTitle> - <appTitle>.

        Args: 
            dialogTitle (str): The dialog title (first part of the window title)
            appTitle (str): The application title (last part of the window title)

        """
        appTitle = f' - {appTitle or ""}' if len(appTitle or '') > 0 else ''
        super(QSettingsDialog, self).setWindowTitle(f'{dialogTitle}{appTitle}')

    def openPreferences(self, appTitle: str = None) -> ('QtCore.QSettings', bool):
        """ Overwrite the parent method.

        Args: 
            appTitle (str, optional): The application title (default None)
        
        Returns:
            (QtCore.QSettings, bool): The current settings and either or not the Accept button has been clicked

        """
        self.setWindowTitle('Preferences', appTitle)

        self.globalWorkdirInput.setText(str(self._settings.value('global/workdir', QtCore.QDir.homePath())))
        self.globalArchiveInput.setCurrentIndex(self.globalArchiveInput.findText(self._settings.value('global/archive', 'tar')))
        self.globalDelayInput.setValue(min(max(int(self._settings.value('global/delay', 5)), 0), 60))

        return self.show()

    def accept(self) -> 'QtWidgets.QDialog.DialogCode' :
        """ Overwrite the parent method.

        Returns:
            QtWidgets.QDialog.DialogCode: Either or not the Accept button has been clicked

        """
        self._settings.setValue('global/workdir', self.globalWorkdirInput.text())
        self._settings.setValue('global/archive', self.globalArchiveInput.currentText())
        self._settings.setValue('global/delay', self.globalDelayInput.value())

        return super(QSettingsDialog, self).accept()

